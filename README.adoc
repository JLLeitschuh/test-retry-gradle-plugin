:imagesdir: docs/images
:toc:
:toc-placement!:

= Test Retry Gradle Plugin

A Gradle plugin that augments Gradle’s built-in Test task with the ability to retry tests that have failed for the purpose of mitigating test flakiness.

image:https://img.shields.io/github/license/gradle/test-retry-gradle-plugin["GitHub license",link="https://github.com/gradle/test-retry-gradle-plugin/blob/master/LICENSE"]
image:https://img.shields.io/maven-metadata/v/https/plugins.gradle.org/m2/org/gradle/test-retry/org.gradle.test-retry.gradle.plugin/maven-metadata.xml.svg?label=version[]

toc::[]

== What it does

The plugin causes failed tests to be retried within the same task.
After executing all tests, any failed tests are retried.
The process repeats with tests that continue to fail until the maximum specified number of retries has been attempted,
or there are no more failing tests.
The generated test reports detail every execution of the tests.

By default, all failed tests passing on retry prevents the test task from failing.
This mode prevents _flaky_ tests from causing build failure.
This setting can be changed so that flaky tests cause build failure, which can be used to identify flaky tests.

== Usage

The plugin is available from the Gradle plugin portal with ID https://plugins.gradle.org/plugin/org.gradle.test-retry[`org.gradle.test-retry`].
It is compatible with Gradle 5.0 and later versions.

By default, retrying is not enabled.
Retrying is configured per test task via the `retry` extension added to each task by the plugin.

.build.gradle
[source,groovy]
----
plugins {
    id 'org.gradle.test-retry' version 'VERSION'
}

test {
    retry {
        maxRetries = 3
        maxFailures = 20
        failOnPassedAfterRetry = true
    }
}
----

The extension is of the following type:

[source,java]
----
package org.gradle.testretry;

import org.gradle.api.provider.Property;
import org.gradle.api.tasks.testing.Test;

/**
 * Allows configuring test retry mechanics.
 * <p>
 * This extension is added with the name 'retry' to all {@link Test} tasks.
 */
public interface TestRetryTaskExtension {

    /**
     * Whether tests that initially fails and then pass on retry should fail the test task.
     * <p>
     * This setting defaults to {@code false},
     * which results in the task not failing if all tests pass on retry.
     * <p>
     * This setting has no effect if {@link Test#getIgnoreFailures()} is set to true.
     *
     * @return whether tests that initially fails and then pass on retry should fail the test task
     */
    Property<Boolean> getFailOnPassedAfterRetry();

    /**
     * The maximum number of times to retry an individual test.
     * <p>
     * This setting defaults to {@code 0}, which results in no retries.
     * Any value less than 1 disables retrying.
     *
     * @return the maximum number of times to retry an individual test
     */
    Property<Integer> getMaxRetries();

    /**
     * The maximum number of test failures that are allowed before retrying is disabled.
     * <p>
     * The count applies to each round of test execution.
     * For example, if maxFailures is 5 and 4 tests initially fail and then 3 again on retry,
     * this will not be considered too many failures and retrying will continue (if maxRetries {@literal >} 1).
     * If 5 or more tests were to fail initially then no retry would be attempted.
     * <p>
     * This setting defaults to {@code 0}, which results in no limit.
     * Any value less than 1 results in no limit.
     *
     * @return the maximum number of test failures that are allowed before retrying is disabled
     */
    Property<Integer> getMaxFailures();

}
----

== Supported test frameworks

Other versions are likely to work as well, but are not tested.

[%header,cols=2*]
|===
|Framework
|Version Tested

|JUnit4
|4.12

|JUnit5
|5.5.2

|Spock
|1.3-groovy-2.5

|TestNG
|7.0.0
|===

=== Parameterized tests

In a few cases, test selection for testing frameworks limits the granularity at which tests can be retried.
In each case, this plugin retries at worst at method level.
For JUnit5 `@ParameterizedTest`, TestNG `@Test(dataProvider = "...")`,
and Spock `@Unroll` tests the plugin will retry the entire method with all parameters including those that initially passed.

=== Test dependencies

The plugin supports retrying Spock `@Stepwise` tests and TestNG `@Test(dependsOn = { … })` tests.

* Upstream tests (those that the failed test depends on) are run because the flaky test may depend on state from the prior execution of an upstream test.
* Downstream tests are run because a flaky test causes any downstream tests to be skipped in the initial test run.

== Effect on reporting

The approach to reporting is to simply report each execution discretely, as opposed to inventing some kind of aggregate outcome. Each execution of a retried test will be reported. This has the least effect on test reporters in other tools like IDEs and continuous integration environments that expect one of a set of previously known outcomes for each test.


=== In Gradle build scans

Gradle build scans show each invocation of a test with its outcome:

image::build-scans-test-retry-reporting.png[Build Scans test reporting, align="center", title=Gradle build scans plugin reporting retried tests]

=== In IDEs

The plugin has been tested with link:url[Idea, https://www.jetbrains.com/idea], link:url[Eclipse IDE, https://www.eclipse.org] and link:url[Netbeans, https://www.netbeans.org].

==== Idea

When delegating test execution to Gradle, each execution is reported discretely as we do for the test reports. Running tests with no Gradle delegation causes tests to not be retried.

image::idea-test-retry-reporting.png[Idea test reporting, align="center", title=Idea test retry reporting]

==== Eclipse

When delegating test execution to Gradle, each execution is reported discretely as we do for the test reports. Running tests with no Gradle delegation causes tests to not be retried.

image::eclipse-test-retry-reporting.png[Eclipse test reporting, align="center", title=Eclipse test retry reporting]

==== Netbeans
Netbeans only shows the last execution of a test.

image::netbeans-test-retry-reporting.png[Netbeans test reporting, align="center", title=Netbeans test retry reporting]

=== On CI servers

The plugin has been tested with the reporting of link:url[TeamCity, https://www.jetbrains.com/teamcity] and link:url[Jenkins, https://www.jenkins.io].

==== TeamCity
Flaky tests (tests being executed multiple times but with different results) are detected by TeamCity and marked as flaky.
TeamCity lists each test that was executed and how often it was run in the build.

image::teamcity-test-retry-reporting.png[Teamcity test reporting, align="center", title=TeamCity test retry reporting including flaky test detection]

==== Jenkins

Jenkins reports each test execution discretely.

image::jenkins-test-retry-reporting.png[Jenkins test reporting, align="center", title=Jenkins test retry reporting]
